import*as e from"worker_threads";import r from"axios";import i from"fs";import n from"path";import t from"os";import{execSync as o}from"child_process";import{GenerateFingerprint as a,ConnectFingerprinter as l}from"playwright-anti-fingerprinter";import{firefox as s}from"playwright";import{createCursor as d}from"ghost-cursor-playwright";var u=(e=>"undefined"!=typeof require?require:"undefined"!=typeof Proxy?new Proxy(e,{get:(e,r)=>("undefined"!=typeof require?require:e)[r]}):e)((function(e){if("undefined"!=typeof require)return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')})),{platform:p}=process,c={darwin:"ioreg -rd1 -c IOPlatformExpertDevice",win32:`${{native:"%windir%\\System32",mixed:"%windir%\\sysnative\\cmd.exe /c %windir%\\System32"}[function(){if("win32"!==process.platform)return"";if("ia32"===process.arch&&process.env.hasOwnProperty("PROCESSOR_ARCHITEW6432"))return"mixed";return"native"}()]}\\REG.exe QUERY HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Cryptography /v MachineGuid`,linux:"( cat /var/lib/dbus/machine-id /etc/machine-id 2> /dev/null || hostname ) | head -n 1 || :",freebsd:"kenv -q smbios.system.uuid || sysctl -n kern.hostuuid"};var v=n.dirname(new URL(import.meta.url).pathname),m=n.resolve(v,"..","imports"),g=n.resolve(m,"tmp");!function(e){switch(p){case"darwin":return e.split("IOPlatformUUID")[1].split("\n")[0].replace(/\=|\s+|\"/gi,"").toLowerCase();case"win32":return e.toString().split("REG_SZ")[1].replace(/\r+|\n+|\s+/gi,"").toLowerCase();case"linux":case"freebsd":return e.toString().replace(/\r+|\n+|\s+/gi,"").toLowerCase();default:throw new Error(`Unsupported platform: ${process.platform}`)}}(o(c[p]).toString());var f=async e=>{let t=e;if(e.includes("http://")||e.includes("https://")){const o=(e=>u("crypto").createHash("md5").update(e).digest("hex"))(e),{data:a}=await r.get(e);((e,r)=>{i.existsSync(n.resolve(m,"tmp"))||i.mkdirSync(g),i.writeFileSync(n.resolve(g,e),r)})(o+".mjs",a),process.on("exit",(()=>{i.unlinkSync(t)}))}const{default:o}=await import(t);return o};Math.random().toString(36).substr(2,9);var h=async e=>await d(e);var w={start:async e=>{const{target:r,proxy:o,fingerprint:d}=e,u={headless:!1,proxy:o,fingerprint:d};return await async function(e){var r,i,n,t,o,d,u,p,c,v,m,g,f,w,y,x,b,S,D,C,M,E,_,P,q,A;let I=a("firefox",{webgl_vendor:e=>e.includes("Intel")||e.includes("AMD")||e.includes("NVIDIA"),webgl_renderer:e=>!0,userAgent:e=>e.includes("Win"),language:e=>e.includes("en"),viewport:e=>e.width>1e3&&e.height>600&&e.width<2e3&&e.height<1500,cpus:e=>e<=32&&e>=4,memory:e=>e<=8,compatibleMediaMimes:e=>(e.audio.includes("aac"),e.video.mp4&&e.video.mp4.length>0),proxy:()=>"direct"});const U={};U.viewport={width:(null==(i=null==(r=null==e?void 0:e.fingerprint)?void 0:r.screen)?void 0:i.width)||I.viewport.width,height:(null==(t=null==(n=null==e?void 0:e.fingerprint)?void 0:n.screen)?void 0:t.height)||I.viewport.height,colorDepth:(null==(d=null==(o=null==e?void 0:e.fingerprint)?void 0:o.screen)?void 0:d.colorDepth)||I.viewport.colorDepth,pixelDepth:(null==(p=null==(u=null==e?void 0:e.fingerprint)?void 0:u.screen)?void 0:p.pixelDepth)||I.viewport.pixelDepth},U.navigator={oscpu:null==(v=null==(c=null==e?void 0:e.fingerprint)?void 0:c.navigator)?void 0:v.oscpu,platform:null==(g=null==(m=null==e?void 0:e.fingerprint)?void 0:m.navigator)?void 0:g.platform,userAgent:null==(w=null==(f=null==e?void 0:e.fingerprint)?void 0:f.navigator)?void 0:w.userAgent,language:"en-US",languages:["en-US","en"],hardwareConcurrency:null==(x=null==(y=null==e?void 0:e.fingerprint)?void 0:y.navigator)?void 0:x.hardwareConcurrency,mimeTypes:null==(S=null==(b=null==e?void 0:e.fingerprint)?void 0:b.navigator)?void 0:S.mimeTypes,plugins:null==(C=null==(D=null==e?void 0:e.fingerprint)?void 0:D.navigator)?void 0:C.plugins},U.cpu=(null==(E=null==(M=null==e?void 0:e.fingerprint)?void 0:M.navigator)?void 0:E.hardwareConcurrency)||I.cpu,U.memory=(null==(P=null==(_=null==e?void 0:e.fingerprint)?void 0:_.navigator)?void 0:P.hardwareConcurrency)||I.memory,U.compatibleMediaMime=(null==(A=null==(q=null==e?void 0:e.fingerprint)?void 0:q.navigator)?void 0:A.mediaMimes)||I.compatibleMediaMime,U.proxy="direct";let O={},R={save:(e,r,i,n)=>new Promise(((r,t)=>{O[e]={expires:i,Data:n},r(!0)})),read:e=>new Promise(((r,i)=>{let n=O[e];return n?Date.now()>=n.expires?(delete O[e],r(!1)):void r(n.Data):r(!1)}))};const T=await s.launch({headless:e.headless,proxy:e.proxy,firefoxUserPrefs:{"general.useragent.override":U.navigator.userAgent,"general.oscpu.override":U.cpu,"general.platform.override":U.navigator.platform,"intl.accept_languages":U.navigator.languages.join(","),"intl.accept_charsets":"UTF-8,ISO-8859-1","dom.webdriver.enabled":!1,"media.navigator.enabled":!0,"media.navigator.video.enabled":!0,"media.navigator.permission.disabled":!0,"media.peerconnection.enabled":!0,"media.peerconnection.ice.default_address_only":!1}}),k=await T.newContext(),L=await k.newPage();await l("firefox",L,{fingerprint:I,requestInterceptor:function(e,r,i){return i.request(),"direct"},cache:R});const F=await h(L);return{page:L,browser:T,context:k,cursor:h,mouse:F}}(u).then((async({page:i,browser:n,context:t,cursor:o,mouse:a})=>{await f(e.job).then((async e=>{await i.goto(r.url,{timeout:0}),await i.waitForTimeout(5e3),await e({page:i,browser:n,context:t,cursor:o,mouse:a}).then((()=>{setTimeout((()=>{process.exit(0)}),1e4)}))}))})).catch((e=>{console.log(e)})).finally((()=>{(()=>{const e=n.resolve(t.tmpdir());i.readdirSync(e).forEach((r=>{(r.includes("firefox")||r.includes("chrome")||r.includes("chromium"))&&i.unlinkSync(n.resolve(e,r))}))})()}))}};e.isMainThread?process.exit(0):e.parentPort.on("message",(async e=>{if(w[e.intent])return await w[e.intent](e.data)}));
